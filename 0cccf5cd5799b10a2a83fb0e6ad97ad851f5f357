{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "0274f9a9_dbc70e58",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 12,
      "author": {
        "id": 5020
      },
      "writtenOn": "2023-03-14T20:29:31Z",
      "side": 1,
      "message": "Add `Bug: b/272139363`",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "eef33b8a_7d6949be",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 12,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:33:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "0274f9a9_dbc70e58",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4bce11d0_5bda8d30",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T20:32:42Z",
      "side": 1,
      "message": "Please add the following bug link before this line:\n\nBug: b/272139363",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "24d0dcd2_523fee01",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:33:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "4bce11d0_5bda8d30",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "96ddd99f_3955bee2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T20:32:42Z",
      "side": 1,
      "message": "Thanks for the patch. I have some questions.",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "535db181_79d723a4",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1200,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T20:32:42Z",
      "side": 1,
      "message": "Nit: compute \u003d\u003e \"computation\" or \"expression\" ?",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c5c1949c_71c46817",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1200,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:33:38Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "535db181_79d723a4",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "11840bd4_c866b8b3",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1212,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T20:32:42Z",
      "side": 1,
      "message": "This threshold seems too low. In the bug report, `a[l]` is -536870912, so the absolute value is 0x20000000 \u003d 1 \u003c\u003c 29. `WIENER_TAP_SCALE_FACTOR` is only 1 \u003c\u003c 16.\n\nI just wanted to confirm you meant to set this threshold. If the threshold is correct, it would be good to add a comment to explain why it is the threshold.\n\nNote: I can increase `scale_threshold` to 1 \u003c\u003c 28 and still pass the reproducer testcase of b/272139363.",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e88d15ed_7c052809",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1212,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:33:38Z",
      "side": 1,
      "message": "scale_threshold \u003d WIENER_TAP_SCALE_FACTOR is guaranteed safe in that smaller a_l will not increase the dynamic range in the initial computation. In the caller, wiener_decompose_sep_sym(), a seems to be initialized to \u003c 16 bits.\n\nThe test max_a_l are: \n536870912\n390152469\n89115\n536870912\n70126\n66560\n65992\n65902\n70786\n67546\n66594\n66312\n536870912\n536870912\n79928\n75308\n\nIf this test accurately captures the range of a_l and more importantly Hc, we can bump it up. I just bumped it to 2 * WIENER_TAP_SCALE_FACTOR, that should cover all but the largest five cases.",
      "parentUuid": "11840bd4_c866b8b3",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e1756587_e6a29f3f",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1212,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:53:32Z",
      "side": 1,
      "message": "Forgot to mention, the main potential issue here would be how big Hc gets. That term should be pixel correlation statistics, i.e., correlations accumulated. I don\u0027t know what the max RU size is in AV1. If that is known we can calculate a better safe threshold.",
      "parentUuid": "e88d15ed_7c052809",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "55793954_01269bd1",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1212,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T22:10:03Z",
      "side": 1,
      "message": "Thanks for the explanation. It would be good to briefly explain how you arrived at the threshold in a comment.",
      "parentUuid": "e1756587_e6a29f3f",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd8e14b7_55c255f9",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1214,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T20:32:42Z",
      "side": 1,
      "message": "`scale_a_l` and `scale_compound` are equal. Do they need to be separate variables?",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8169f1a8_4c6cdd10",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1214,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T20:32:42Z",
      "side": 1,
      "message": "Optional: It is not necessary to calculate `max_a_l`. The following is equivalent:\n\n```\n  const int scale_threshold \u003d WIENER_TAP_SCALE_FACTOR;\n  int scale_a_l \u003d 1;\n  int scale_compound \u003d 1;\n  for (int l \u003d 0; l \u003c wiener_win; ++l) {\n    const int32_t abs_a_l \u003d abs(a[l]);\n    if (abs_a_l \u003e\u003d scale_threshold) {\n      scale_a_l \u003d 2;\n      scale_compound \u003d 2;\n      break;\n    }\n  }\n```",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c373a82c_41c44c8a",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1214,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:33:38Z",
      "side": 1,
      "message": "I prefer them separate but reverted to single.",
      "parentUuid": "cd8e14b7_55c255f9",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a39df24d_85fb3c88",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1214,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:33:38Z",
      "side": 1,
      "message": "The number of taps is small. IMO existing version is more readable.",
      "parentUuid": "8169f1a8_4c6cdd10",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fc42b645_86e3d8bf",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1214,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T22:07:24Z",
      "side": 1,
      "message": "The existing version is fine by me. I was just pointing out that `max_a_l \u003c scale_threshold` is equivalent to `abs(a[l]) \u003c scale_threshold for all l`.",
      "parentUuid": "a39df24d_85fb3c88",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "848a3e14_b4de675e",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1226,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T20:32:42Z",
      "side": 1,
      "message": "It is slightly more accurate to change this line to:\n\n```\n              (WIENER_TAP_SCALE_FACTOR / scale_a_l / scale_compound);\n```\n\nWith the current code, if `scale_a_l` and `scale_compound` are equal to 2, then the two least significant bits of the final result (on the right hand side of `+\u003d`) will always be 0.\n\nNote: `WIENER_TAP_SCALE_FACTOR` is a compile-time constant. Since it is a power of 2, the compiler can implement the division by `WIENER_TAP_SCALE_FACTOR` with a right shift. My suggested change may cause the compiler to actually do a division. We need to consider this issue if this code needs to be optimized well.",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5b69ced3_88ddc0a6",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1226,
      "author": {
        "id": 26732
      },
      "writtenOn": "2023-03-14T21:33:38Z",
      "side": 1,
      "message": "Done. I don\u0027t know if it is worth doing signed rounding here, but we could.\n\n\u003e the compiler can implement the division by WIENER_TAP_SCALE_FACTOR with a right shift. \n\n\nAre you sure? Because the numbers are signed I am not sure what the compiler will do.",
      "parentUuid": "848a3e14_b4de675e",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "db0ff764_537c3a71",
        "filename": "av1/encoder/pickrst.c",
        "patchSetId": 2
      },
      "lineNbr": 1226,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-03-14T22:07:24Z",
      "side": 1,
      "message": "The compiler needs to handle a negative dividend before the right shift to truncate towards zero. A plain right shift truncates down.\n\nHere is an experiment. You can see the right-shift-by-16 instructions in both the unsigned and signed versions of the Divide funtion:\n\n```\n$ cat divide.c\n#define WIENER_TAP_SCALE_FACTOR (1 \u003c\u003c 16)\n\nunsigned int DivideUnsigned(unsigned int n) {\n  return n / WIENER_TAP_SCALE_FACTOR;\n}\n\nint DivideSigned(int n) {\n  return n / WIENER_TAP_SCALE_FACTOR;\n}\n$ clang -Wall -Wextra -O2 -S -c divide.c\n$ cat divide.s\n\t.text\n\t.file\t\"divide.c\"\n\t.globl\tDivideUnsigned                  # -- Begin function DivideUnsigned\n\t.p2align\t4, 0x90\n\t.type\tDivideUnsigned,@function\nDivideUnsigned:                         # @DivideUnsigned\n\t.cfi_startproc\n# %bb.0:\n\tmovl\t%edi, %eax\n\tshrl\t$16, %eax\n\tretq\n.Lfunc_end0:\n\t.size\tDivideUnsigned, .Lfunc_end0-DivideUnsigned\n\t.cfi_endproc\n                                        # -- End function\n\t.globl\tDivideSigned                    # -- Begin function DivideSigned\n\t.p2align\t4, 0x90\n\t.type\tDivideSigned,@function\nDivideSigned:                           # @DivideSigned\n\t.cfi_startproc\n# %bb.0:\n                                        # kill: def $edi killed $edi def $rdi\n\tleal\t65535(%rdi), %eax\n\ttestl\t%edi, %edi\n\tcmovnsl\t%edi, %eax\n\tsarl\t$16, %eax\n\tretq\n.Lfunc_end1:\n\t.size\tDivideSigned, .Lfunc_end1-DivideSigned\n\t.cfi_endproc\n                                        # -- End function\n\t.ident\t\"Debian clang version 14.0.6\"\n\t.section\t\".note.GNU-stack\",\"\",@progbits\n\t.addrsig\n```",
      "parentUuid": "5b69ced3_88ddc0a6",
      "revId": "0cccf5cd5799b10a2a83fb0e6ad97ad851f5f357",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}