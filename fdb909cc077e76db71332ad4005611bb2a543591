{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "aea4ceef_2b7e4599",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-02-05T12:38:21Z",
      "side": 1,
      "message": "Hi Wan-Teh,\n\nIn this patch, we tried reducing the bit stream buffer size for AVIF encode. \n\nIn parent version, the stream buffer is allocated as frame_size * 8. As per our understanding this should have been frame_size. Hence we tried understanding the modifications to this code (in the past) and found that the multiplication factor is introduced considering multiple no-show frames in succession. The relevant history (from VP9 encoder) can be found below:\n\nhttps://chromium-review.googlesource.com/c/webm/libvpx/+/47381/12/vp9/vp9_cx_iface.c\nhttps://chromium-review.googlesource.com/c/webm/libvpx/+/70949/2/vp9/vp9_cx_iface.c\n\nAs per our understanding, the buffer size can be reduced when lag-in-frames \u003c\u003d 1 as alt-ref frames are not enabled for this case. Also, pyramid height can be used to decide the maximum number of successive no-show frames, when lag-in-frames \u003e 1. The current patch limits the allocated stream size based on above, to reduce the HEAP memory requirements of AVIF encode. \n\nFor libaom AV1 video encode, bit match is verified (w.r.t parent commit) for few videos with different video encoding configurations.\nIt was verified that output of AVIF encode is bit-exact with parent version for a typical image dataset.\n\nFollowing are memory reduction results when AVIF encode was tested for ‘building.jpg’ (4032x3024) image at cq_level\u003d18.\n\n   Speed                 HEAP Memory\n   preset                Reduction(%)\n     6          ~21.5 (from 568.6 MB to 445.9 MB)\n\nAs this change is also applicable to both ‘good’ (with –lag-in-frames\u003d35) and ‘real-time’ (with –lag-in-frames\u003d0) configurations, we have measured the memory reduction for a 1280x720 content.\n\n   Encoding           Speed                 HEAP Memory\n   Configuration     preset                Reduction(%)\n     GOOD              6           ~1.1 (from 244.90 MB to 242.20 MB)\n     RT                7           ~14.8 (from 63.66 MB to 54.23 MB)\n\nHEAP memory reduction was measured using the command below.\n$valgrind --tool\u003dmassif ./avifenc ...\n\nThanks \u0026 Regards,\nVenkata.",
      "revId": "fdb909cc077e76db71332ad4005611bb2a543591",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}