{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "7abe3f32_a704c24c",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 14,
      "author": {
        "id": 5022
      },
      "writtenOn": "2021-03-02T02:36:39Z",
      "side": 1,
      "message": "Since this change only affects chroma component, could you please add the BD-rate change in PSNR-U and PSNR-V too? Thanks.",
      "range": {
        "startLine": 14,
        "startChar": 31,
        "endLine": 14,
        "endChar": 38
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "165f88ed_ced19bca",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 14,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-02T19:09:55Z",
      "side": 1,
      "message": "Hi Jingning,\n\nWe have updated commit message with BD-rate data of Cb and Cr. However, we updated all the data (speed and BD-rate data) by excluding the data of \u00272048x1320_mika-ruusunen-683.png\u0027 image content in this patch.\n\nWe observed that \u00272048x1320_mika-ruusunen-683.png\u0027 has non-monotonic R-D plot in the parent version for PSNR cb and cr (speed\u003d4, 5 presets). Though our change has same psnrs as parent version for cb and cr, non-monotonic nature of R-D plot seems to have led to invalid BD-rate. Hence we excluded the data of the same in all the metrics. We shall file an issue for the same.\n\nP.S. \u00272048x1320_mika-ruusunen-683.png\u0027 has 3 planes and seems to have all cb and cr values near 128.",
      "parentUuid": "7abe3f32_a704c24c",
      "range": {
        "startLine": 14,
        "startChar": 31,
        "endLine": 14,
        "endChar": 38
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "51a73158_d738c3f1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 6
      },
      "lineNbr": 14,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-04T19:29:08Z",
      "side": 1,
      "message": "Hi Wan-Teh and Jingning,\n\nWe have raised following bug to report the issue related to the image content \u00272048x1320_mika-ruusunen-683.png\u0027.\nhttps://bugs.chromium.org/p/aomedia/issues/detail?id\u003d2983\n\nAs per our understanding, the behavior is not unexpected as overall psnr is improving.",
      "parentUuid": "165f88ed_ced19bca",
      "range": {
        "startLine": 14,
        "startChar": 31,
        "endLine": 14,
        "endChar": 38
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ce264fd6_84bc3471",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-01T14:27:31Z",
      "side": 1,
      "message": "Hi Wan-Teh,\n\nAs per the analysis, we observed that the chroma intra mode winner is either of the following ~88% of times. \n1. UV_DC_PRED,\n2. UV_SMOOTH_PRED \n3. UV_CFL_PRED\n4. the mode that corresponds to luma intra mode winner.\n\nThe possibility of remaining chroma intra modes winning seemed to be less. Hence we implemented a logic to prune chroma intra modes based on above observations.\n\nWe validated the current patch for all-intra video and still-image encode. Specifically, we configured libaom in ALLINTRA mode (in libavif) for AVIF encode. \nThe optimization is not currently enabled for speed presets \u003e\u003d 4 as the results for lower presets are not with in the expected speed-quality trade-off.\n\nFollowing are encode time reduction results when AVIF encode was tested for a typical image dataset. Bit match is verified for presets \u003c\u003d 3.\n                Instruction Count  BD-Rate Loss(%)       \n      cpu-used    Reduction(%)     psnr     ssim    \n         4          4.990          0.1203   0.1523  \n         5          4.375          0.1290   0.1210  \n         6          7.150          0.1148   0.1627  \n\nWe have also done timer based tests for speed 6 and observed that the encode time reduction was 7.94%.\n\nFollowing are encode time reduction results when tested libaom with all intra frame encoding for a borg setup. Bit match is verified for presets \u003c\u003d 3.\n               Instruction Count       BD-Rate Loss(%)       \n     cpu-used    Reduction(%)     avg.psnr  ovr.psnr   ssim    \n        4          6.079          0.2304    0.2307    0.2805  \n        5          5.447          0.2281    0.2260    0.2768  \n        6          9.170          0.2415    0.2414    0.3072\n\nFor libaom AV1 video encode, bit match is verified (w.r.t parent commit) for encoding modes \u0027GOOD\u0027 and \u0027RT\u0027 for few videos with different video encoding configurations.\n\nPlease review the patch.\n\nThanks,\nVenkata.",
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "51e7a2b9_c3ee9c5c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-03-02T02:04:33Z",
      "side": 1,
      "message": "Jingning: PTAL. Thanks!",
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a5a22b81_712ede23",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-03-02T02:08:32Z",
      "side": 1,
      "message": "Hi Venkata,\n\nThank you for the CL! I am wondering why this change is restricted to all intra mode. Is it inappropriate for the intra frames in the good-quality or real-time mode?",
      "parentUuid": "ce264fd6_84bc3471",
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9630f7d1_53a0bb01",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-02T19:09:55Z",
      "side": 1,
      "message": "As this optimization is for intra frames we have enabled it for all intra encoding for now. Once the patch is merged, we will try to introduce this optimization to other encoding modes and shall submit the patch based on the results.",
      "parentUuid": "a5a22b81_712ede23",
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "658ba90b_4d561f9f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-04T19:29:08Z",
      "side": 1,
      "message": "Hi Wan-Teh,\n\nWe went ahead and generated the data for video encode mode and following are the results.\n\nFor \u0027good\u0027 quality encoding mode\n               Instruction Count       BD-Rate Loss(%)       \n     cpu-used    Reduction(%)     avg.psnr  ovr.psnr   ssim  \n        4           0.37          0.0506    0.0559     0.0716      \n        5           0.56          0.2082    0.2015     0.2505\n        6           0.58          0.2048    0.2043     0.2652\n\nFor \u0027real-time\u0027 encoding mode,\n               Instruction Count       BD-Rate Loss(%)       \n     cpu-used    Reduction(%)     avg.psnr  ovr.psnr   ssim  \n        4           0.230        -0.0158    0.0259     0.1388   \n\nFrom the results, we can say that speed-up and trade-off are not encouraging for video encode. This seems to be due to lesser scope for speed-up in case of video encode, using this optimization.     \nCurrently for \u0027real-time\u0027 encoding mode (speed \u003e\u003d 5), chroma modes are evaluated as given below (varies depending on the preset). \n1) UV_DC_PRED\n2) UV_CFL_PRED\n3) Force chroma mode same as that of luma mode (UV_DC_PRED, UV_H_PRED and UV_V_PRED)\n\nHence the current optimization is not helpful in this case as well.",
      "parentUuid": "9630f7d1_53a0bb01",
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2c4a111a_bec99b8f",
        "filename": "av1/encoder/intra_mode_search.c",
        "patchSetId": 6
      },
      "lineNbr": 496,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-03-02T02:04:33Z",
      "side": 1,
      "message": "IMPORTANT: The av1_derived_chroma_intra_mode_used_flag array has 13 (\u003d INTRA_MODES) elements. Is mbmi-\u003emode always \u003c 13 here?",
      "range": {
        "startLine": 496,
        "startChar": 50,
        "endLine": 496,
        "endChar": 60
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b70febe6_a4ce0487",
        "filename": "av1/encoder/intra_mode_search.c",
        "patchSetId": 6
      },
      "lineNbr": 496,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-02T19:09:55Z",
      "side": 1,
      "message": "mbmi-\u003emode is of enum type PREDICTION_MODE, which includes all possible intra and inter prediction modes. As the function av1_rd_pick_intra_sbuv_mode() is specific to chroma intra prediction and chroma intra prediction is coupled with luma intra prediction, it is ensured that the value of mbmi-\u003emode will be less than 13 (DC_PRED(0) to PAETH_PRED(12)). However, we have added an assert for the same. Also please refer to the code given below to check mbmi-\u003emode possible values to this function.\n\n  // Search through angle delta\n    const int rate_overhead \u003d\n       mode_costs-\u003eintra_uv_mode_cost[is_cfl_allowed(xd)][mbmi-\u003emode][mode];\n    if (!rd_pick_intra_angle_sbuv(cpi, x, bsize, rate_overhead, best_rd,\n                                  \u0026this_rate, \u0026tokenonly_rd_stats))\n       continue;",
      "parentUuid": "2c4a111a_bec99b8f",
      "range": {
        "startLine": 496,
        "startChar": 50,
        "endLine": 496,
        "endChar": 60
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "eb5ac694_17d57c15",
        "filename": "av1/encoder/intra_mode_search.c",
        "patchSetId": 6
      },
      "lineNbr": 496,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-03-11T01:47:46Z",
      "side": 1,
      "message": "Thanks!",
      "parentUuid": "b70febe6_a4ce0487",
      "range": {
        "startLine": 496,
        "startChar": 50,
        "endLine": 496,
        "endChar": 60
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2367eaf4_383ae164",
        "filename": "av1/encoder/intra_mode_search_utils.h",
        "patchSetId": 6
      },
      "lineNbr": 101,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-03-02T02:04:33Z",
      "side": 1,
      "message": "Nit: In \"The table av1_derived_chroma_intra_mode_used_flag table\", delete either the first or the second \"table\".",
      "range": {
        "startLine": 100,
        "startChar": 62,
        "endLine": 101,
        "endChar": 48
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5577592a_a3caff7d",
        "filename": "av1/encoder/intra_mode_search_utils.h",
        "patchSetId": 6
      },
      "lineNbr": 101,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-02T19:09:55Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "2367eaf4_383ae164",
      "range": {
        "startLine": 100,
        "startChar": 62,
        "endLine": 101,
        "endChar": 48
      },
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "99eac796_2a7f44b1",
        "filename": "av1/encoder/intra_mode_search_utils.h",
        "patchSetId": 6
      },
      "lineNbr": 123,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-03-02T02:04:33Z",
      "side": 1,
      "message": "Since this table is only used in av1/encoder/intra_mode_search.c, I would move this table to that file.",
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f69760d7_e3619439",
        "filename": "av1/encoder/intra_mode_search_utils.h",
        "patchSetId": 6
      },
      "lineNbr": 123,
      "author": {
        "id": 9611
      },
      "writtenOn": "2021-03-02T19:09:55Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "99eac796_2a7f44b1",
      "revId": "65f117647ea2586ca9bd0d034ea258b700c04f25",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}