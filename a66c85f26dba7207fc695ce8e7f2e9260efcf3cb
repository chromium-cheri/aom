{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "652bce12_c00f9930",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2022-12-30T00:53:54Z",
      "side": 1,
      "message": "I made two simple changes in patchset 6.\n\nBohan, please review the diffs between patchsets 5 and 6. Thanks.",
      "revId": "a66c85f26dba7207fc695ce8e7f2e9260efcf3cb",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f76c8b9e_109256e7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 31322
      },
      "writtenOn": "2023-01-04T09:12:44Z",
      "side": 1,
      "message": "Hi Wan-Teh,\n\nPlease let us know your suggestions.",
      "revId": "a66c85f26dba7207fc695ce8e7f2e9260efcf3cb",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2c32e582_1fc1372e",
        "filename": "av1/av1_cx_iface.c",
        "patchSetId": 6
      },
      "lineNbr": 2527,
      "author": {
        "id": 9545
      },
      "writtenOn": "2022-12-30T02:35:27Z",
      "side": 1,
      "message": "IMPORTANT: I just realized that `oxcf-\u003ekf_cfg.key_freq_max` may be changed during encoding by changing the `cfg-\u003ekf_max_dist` encoder config setting. So whenever the encoder config is set, we should check if `buffer_pool-\u003eframe_bufs` needs to be reallocated.\n\nIn addition to that, I can think of two other possible solutions.\n\n1. We can check `oxcf-\u003emode \u003d\u003d ALLINTRA` instead of `oxcf-\u003ekf_cfg.key_freq_max \u003d\u003d 0` here, and do not allow `cfg-\u003ekf_max_dist` to change in allintra mode. This solution assumes oxcf-\u003emode cannot be changed during encoding.\n\n2. Instead of a fixed-sized array, we can switch to a dynamically-growing array or linked list. For example, we can grow the array or linked list in `get_free_fb()`.",
      "revId": "a66c85f26dba7207fc695ce8e7f2e9260efcf3cb",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b51d6204_d1ed88e1",
        "filename": "av1/av1_cx_iface.c",
        "patchSetId": 6
      },
      "lineNbr": 2527,
      "author": {
        "id": 9545
      },
      "writtenOn": "2022-12-30T03:02:05Z",
      "side": 1,
      "message": "Yet another possible solution is to check `oxcf-\u003einput_cfg.limit \u003d\u003d 1` instead of `oxcf-\u003ekf_cfg.key_freq_max \u003d\u003d 0` here. This helps still image encoding but won\u0027t help allintra video encoding.\n\nI suspect reallocating the array won\u0027t work because cm-\u003eref_frame_map stores pointers to elements in this array, so the addresses of the array elements cannot change when they are in use. This means a linked list is more likely to work if we want a dynamic solution.",
      "parentUuid": "2c32e582_1fc1372e",
      "revId": "a66c85f26dba7207fc695ce8e7f2e9260efcf3cb",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "30c81d4a_850e494e",
        "filename": "av1/av1_cx_iface.c",
        "patchSetId": 6
      },
      "lineNbr": 2527,
      "author": {
        "id": 31322
      },
      "writtenOn": "2023-01-02T16:13:57Z",
      "side": 1,
      "message": "According to our understanding, ‘cfg-\u003ekf_max_dist’ is an encoder init-time parameter which is set to 0 for ALLINTRA usage (please see encoder_usage_cfg []).This cannot be changed during encoding, and even if the user configures it with a non-zero value for ALLINTRA usage, the encoder ignores it as per the below code snippet in parse_stream_params():\nif (global-\u003eusage \u003d\u003d AOM_USAGE_ALL_INTRA) {\nif (config-\u003ecfg.kf_max_dist !\u003d 0) {\naom_tools_warn(\n\"non-zero max key frame distance option ignored in all intra \"\n\"mode.\\n\");\nconfig-\u003ecfg.kf_max_dist \u003d 0;\n}\n}\nHence, we feel that checking \u0027oxcf-\u003ekf_cfg.key_freq_max\u0027 (as kf_cfg.key_freq_max \u003d cfg-\u003ekf_max_dist) to initialize \u0027num_frame_bufs\u0027 would be correct. Checking \u0027oxcf-\u003emode \u003d\u003d ALLINTRA\u0027 is also a possible alternative, but that would restrict this optimization to ALLINTRA mode alone (GOOD or RT modes with kf_max_dist \u003d 0 might not benefit). Checking \u0027oxcf-\u003einput_cfg.limit \u003d\u003d 1\u0027 would also limit this optimization to still-picture encoding. Hence, we feel that the current implementation is recommended. Please let us know your opinion.",
      "parentUuid": "b51d6204_d1ed88e1",
      "revId": "a66c85f26dba7207fc695ce8e7f2e9260efcf3cb",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "40d782e8_fb658e82",
        "filename": "av1/av1_cx_iface.c",
        "patchSetId": 6
      },
      "lineNbr": 2527,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-01-04T22:11:38Z",
      "side": 1,
      "message": "The code snippet you quoted is in apps/aomenc.c. The C API requires `cfg-\u003ekf_max_dist` be 0 with the following code in av1/av1_cx_iface.c:\n\n```\n  if (cfg-\u003eg_usage \u003d\u003d AOM_USAGE_ALL_INTRA) {\n    RANGE_CHECK_HI(cfg, g_lag_in_frames, 0);\n    RANGE_CHECK_HI(cfg, kf_max_dist, 0);\n  }\n```\n\n`cfg-\u003ekf_max_dist` can be changed during encoding by calling `aom_codec_enc_config_set()`. I am worried about an application that uses `AOM_USAGE_GOOD_QUALITY` or `AOM_USAGE_REAL_TIME`, initializes `cfg-\u003ekf_max_dist` to 0, and later changes `cfg-\u003ekf_max_dist` to, say, 100. The current code will allocate `buffer_pool-\u003eframe_bufs` with 2 frame buffers, which will not be enough when `cfg-\u003ekf_max_dist` is increased to 100.\n\nIf libaom\u0027s encoder initialization code already assumes `cfg-\u003ekf_max_dist` doesn\u0027t change during encoding and makes certain decisions based on the `oxcf-\u003ekf_cfg.key_freq_max \u003d\u003d 0` check, then libaom is already vulnerable to this issue and this CL will be okay. I just don\u0027t want this CL to introduce this issue.",
      "parentUuid": "30c81d4a_850e494e",
      "revId": "a66c85f26dba7207fc695ce8e7f2e9260efcf3cb",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "05ecf268_3527ccda",
        "filename": "av1/av1_cx_iface.c",
        "patchSetId": 6
      },
      "lineNbr": 2527,
      "author": {
        "id": 31322
      },
      "writtenOn": "2023-01-06T07:11:35Z",
      "side": 1,
      "message": "Thank you for pointing out  the code. We understand that cfg-\u003ekf_max_dist can change during encoding, and we agree that your first suggestion of using oxcf-\u003emode\u003d\u003dALLINTRA would be the appropriate check to initialize num_frame_bufs. We have pushed the latest patchset with this change after testing. Please let us know your opinion.",
      "parentUuid": "40d782e8_fb658e82",
      "revId": "a66c85f26dba7207fc695ce8e7f2e9260efcf3cb",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}