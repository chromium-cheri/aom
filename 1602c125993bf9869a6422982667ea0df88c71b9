{
  "comments": [
    {
      "key": {
        "uuid": "42773bd9_dd74d201",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 14062
      },
      "writtenOn": "2020-09-28T16:40:35Z",
      "side": 1,
      "message": "Hi Yunqing,\n\nAs has been observed from the analysis of speed feature statistics on 8-bit and 10-bit encoding, the ML classifier \u0027ml_predict_tx_split\u0027 is not enabled for high bit-depth encoding. When we tried to extend similar ML based models for 10-bit encoding (by extending the existing models with necessary rounding as per bit-depth, or by using new ML models trained specifically for 10-bit encodes), the resulting speed-quality trade-offs were not good (more than 0.04% trade-off was seen on speed 2 10-bit encode). We also tried to prune the transform split and no_split evaluation based on residual block’s and sub-blocks’ properties, which yielded better speed-quality trade-off on 10-bit encodes.\n\nIn this patch, the standard-deviation (std) of means and the variance of variances of the residual block and its 4 or 2 sub-blocks are computed and compared against quantiser based thresholds to prune evaluations of transform split or transform no_split blocks, as follows. \n\nPrune tx_split evaluation if \nstd(block/subblock means) \u003c\u003d dc_qstep AND var(block/subblock variances) * thr1 \u003c\u003d ac_qstep^2\n\nPrune tx_no_split evaluation if \nstd(block/subblock means) \u003e thr2 * dc_qstep AND var(block/subblock variances) \u003e thr2 * ac_qstep^2\n\nThe thresholds thr1 and thr2 are such that the pruning is more aggressive for faster speed presets.\n\nThis patch enables the above pruning logic for lowres hbd encoding in speed 0 and 1, and for all resolutions for speed 2 and above. When enabled for midres and hdres in speed 0 and 1, the above logic results in slightly high BD rate loss, with overall trade-off of 0.02% in speed 0 and 0.03% in speed 1. We have pushed a dependent patch (https://aomedia-review.googlesource.com/c/aom/+/120424) that enables the speed feature for midres and hdres of speed 0 and 1 if these trade-offs are OK.\n\nPlease find the detailed borg results on 10-bit encoding below.\n\n                        Instruction Count        BD-Rate Loss(%)\n  cpu-used  Resolution    Reduction(%)   avg.psnr   ovr.psnr     ssim       10-bit avg.psnr\n      0      LOW RES        1.688         0.0088    0.0069      0.0235        0.0067\n      0      AVERAGE        0.847         0.0035    0.0027      0.0094        0.0026\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \n      1      LOW RES        0.854         0.0208    0.0183      0.0397        0.0159\n      1      AVERAGE        0.429         0.0084    0.0074      0.0159        0.0064\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \n      2      LOW RES        1.427         0.0135    0.0134      0.0146        0.0216\n      2      MID RES        0.882        -0.0324   -0.0313      0.0042       -0.0312\n      2      HD RES*        1.815         0.0424    0.0475      0.1333        0.0395\n      2      AVERAGE        1.392         0.0089    0.0107      0.0477        0.0116\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \n      3      LOW RES        0.172         0.0181   -0.0011      0.0424        0.0189\n      3      MID RES        0.205        -0.0497   -0.0627     -0.0729       -0.0523\n      3      HD RES         0.126         0.0341    0.0321      0.0007        0.0388\n      3      AVERAGE        0.168         0.0031   -0.0090     -0.0040        0.0041\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \n      4      LOW RES        0.314         0.0408    0.0408      0.0555        0.0386\n      4      MID RES        0.152        -0.0099   -0.0153     -0.0287       -0.0129\n      4      HD RES         0.336         0.0581    0.0694      0.1036        0.0656\n      4      AVERAGE        0.280         0.0312    0.0331      0.0455        0.0318\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \n      5      LOW RES        0.314         0.0207    0.0083      0.0553        0.0216\n      5      MID RES        0.255         0.0722    0.0715      0.0985        0.0719\n      5      HD RES         0.327         0.0201    0.0282      0.0739        0.0231\n      5      AVERAGE        0.303         0.0356    0.0329      0.0736        0.0368\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \n      6      LOW RES        0.280        -0.0025   -0.0109     -0.0105       -0.0017\n      6      MID RES        0.121         0.0681    0.0563      0.0808        0.0700\n      6      HD RES         0.238         0.0664    0.0617      0.1247        0.0725\n      6      AVERAGE        0.230         0.0392    0.0309      0.0574        0.0419\n               \n               *60 frame runs\n\nFor 12-bit encoding, the above pruning logic resulted in 0.275% encode time reduction with 0.0222% BD rate gain on speed 2 lowres, as below.\n\n                        Instruction Count        BD-Rate Loss(%)\n  cpu-used  Resolution    Reduction(%)   avg.psnr   ovr.psnr     ssim       10-bit avg.psnr\n      2      LOW RES        0.275        -0.0222   -0.0312     -0.0453       -0.0195\n\nFor 8-bit encoding, this is a bit-exact change with no impact on speed (verified locally).\n\nKindly review this patch.\n\nRegards,\nVishesh",
      "revId": "1602c125993bf9869a6422982667ea0df88c71b9",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": false
    }
  ]
}