{
  "comments": [
    {
      "key": {
        "uuid": "d507daec_ed41ff9f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 13265
      },
      "writtenOn": "2020-09-11T11:07:17Z",
      "side": 1,
      "message": "Hi Yunqing,\n\nWhile analysing the difference in performance for SGR loop restoration speed features in 8-bit and 10-bit encodes, we identified that the rd cost computation was not using the proper scaling for sse as per bit-depth in loop restoration. \n\nIn this patch, we have corrected the rd cost computations in loop restoration to have the SSE properly scaled according to the bit-depth. For uniformity, other cases, such as search_filter_level() and encode_with_and_without_superres(), where sse scaling was not taken care of while using RDCOST_DBL() are also corrected to use appropriate scaling of sse as per bit-depth. Though loop filter cost computation (in search_filter_level) is changed, since the no. of bits is 0 there, no impact on speed or quality is expected due to loop filter change. \n\nThe results show BD rate improvement for 10-bit encode for speed 0 to 4 presets, with higher gains at low bitrates. Speed 5 and 6 have no impact on performance since loop restoration is disabled in these presets. \n\nPlease find the detailed borg results for 10-bit encoding below.\n\n         |            |                   |            BD-Rate Impact(%)          |\n         |            | Instruction Count | avg.psnr  ovr.psnr   ssim    avg.psnr |\ncpu-used | Resolution |    Reduction(%)   |   8-bit     8-bit     8-bit   10-bit  |\n-------- | ---------- | ----------------- | --------  --------  -------- -------- |\n   0     |  LOW RES   |      -0.161       | -0.7033   -0.6980   -0.8888  -0.6769  |\n   0     |  MID RES   |      -0.065       | -0.6611   -0.6709   -0.7901  -0.6445  |\n   0     |   HD RES*  |      -0.068       | -0.8974   -0.9014   -0.9889  -0.8624  |\n   0     |  Average   |      -0.114       | -0.7501   -0.7521   -0.8904  -0.7240  |\n\t\t\t\t\t\t\t  \t\t\t\t\t\t\t\t\t\t\t\t  \n   1     |  LOW RES   |      -0.244       | -0.6077   -0.5963   -0.7313  -0.5907  |\n   1     |  MID RES   |       0.110       | -0.6268   -0.6214   -0.7151  -0.6146  |\n   1     |   HD RES*  |      -0.339       | -0.7863   -0.7945   -0.8404  -0.7730  |\n   1     |  Average   |      -0.182       | -0.6677   -0.6641   -0.7598  -0.6533  |\n\t\t\t\t\t\t\t  \t\t\t\t\t\t\t\t\t\t\t\t  \n   2     |  LOW RES   |       0.176       | -0.6128   -0.6110   -0.7615  -0.5926  |\n   2     |  MID RES   |       0.176       | -0.4194   -0.4258   -0.4728  -0.4100  |\n   2     |   HD RES*  |       0.052       | -0.6077   -0.6136   -0.6827  -0.5905  |\n   2     |  Average   |       0.145       | -0.5546   -0.5576   -0.6530  -0.5385  |\n   \n   3     |  LOW RES   |       0.332       | -0.4055   -0.4008   -0.5141  -0.3975  |\n   3     |  MID RES   |       0.318       | -0.1707   -0.1624   -0.2038  -0.1639  |\n   3     |   HD RES   |       0.195       | -0.3185   -0.3022   -0.3007  -0.3165  |\n   3     |  Average   |       0.294       | -0.3103   -0.3010   -0.3582  -0.3044  |\n   \n   4     |  LOW RES   |       0.558       | -0.3787   -0.3836   -0.5217  -0.3725  |\n   4     |  MID RES   |       0.565       | -0.1644   -0.1672   -0.1937  -0.1594  |\n   4     |   HD RES   |       0.403       | -0.3454   -0.3483   -0.3833  -0.3391  |\n   4     |  Average   |       0.521       | -0.3058   -0.3095   -0.3835  -0.3000  |\n   \n   * 60 frame runs\n   \nOn 12-bit encode, please find the results on speed 2 lowres below.\n\n         |            |                   |            BD-Rate Impact(%)          |\n         |            | Instruction Count | avg.psnr  ovr.psnr   ssim    avg.psnr |\ncpu-used | Resolution |    Reduction(%)   |   8-bit     8-bit     8-bit   12-bit  |\n-------- | ---------- | ----------------- | --------  --------  -------- -------- |\n   2     |  LOW RES   |       0.238       | -1.1791   -1.1819   -1.4230  -1.1671  |\n   \nIn the commit message, BD rate impact column:\n[+] sign is for BD-Rate drop\n[-] sign is for BD-Rate improvement\nThe instruction count reduction specified has been measured using command:\n$ perf stat -e instructions:u ./aomenc â€¦\n\nWe also ran a few contents with \u0027--superres-mode\u003d4 --superres-kf-denominator\u003d16 --enable-restoration\u003d0\u0027 to assess the quality impact due to the fix in encode_with_and_without_superres(), and observed BD rate gain for 10-bit encoding for the contents where superres-mode of 4 was having effect (for other contents, it was bit-matching).\n   \nThis is a bit-exact change with no impact on speed for 8-bit encode (verified locally).\n\nPlease review the patch.\n\nRegards,\nNithya\n",
      "revId": "9f02b7191e5f388b8785438788ddcc7f6a9770c8",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "5825a050_fb823486",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 5185
      },
      "writtenOn": "2020-09-11T16:44:31Z",
      "side": 1,
      "message": "Thanks for the fix!",
      "revId": "9f02b7191e5f388b8785438788ddcc7f6a9770c8",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": false
    }
  ]
}