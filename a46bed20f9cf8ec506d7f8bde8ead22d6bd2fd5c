{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "6b717933_effcc2d7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 9101
      },
      "writtenOn": "2021-03-31T16:31:18Z",
      "side": 1,
      "message": "Hi Yunqing,\nWe have identified a thread sanitizer issue while testing RT path. This issue is causing a run-to-run mismatch in few contents (E.g. crew_720p.y4m) for --threads \u003e 1 and --row-mt\u003d0 or 1. Hence there is a mismatch between encoder output with --threads\u003d1 and --threads \u003e 1. After debugging, we could narrow down the issue at pd-\u003edst.buf pointer update in estimate_block_intra() function in RT path.\n\nThe issue is seen as pred buffer pointer is updated twice based on blk_row and blk_col using pd-\u003edst.buf for a given tx block.\n(1) pd-\u003edst.buf pointer is updated based on blk_row and blk_col in estimate_block_intra() function \n(2) dst pointer in av1_predict_intra_block_facade() function is updated based on blk_row and blk_col using pd-\u003edst.buf \n\nThis CL fixes the issue by moving pd-\u003edst.buf update after av1_predict_intra_block_facade() call. The update is still required since block_yrd() and model_rd_for_sb_uv() functions need this update.\n\nThough the issue seem to be common to all encoded contents, it was seen in few contents only as tx split is not enabled in â€“rt preset. The issue is seen only in contents with partial superblocks at frame boundary (as tx split is forced in partial superblocks).\n\nThe encode time impact for RT preset with threads\u003d4, num-tile-cols\u003d4, row-mt\u003d1 (averaged over 360p, 480p, 720p, 1080p).\nBD-Rate loss is measured using Borg test.\n            Encode Time          BD-Rate Loss(%)\ncpu-used    Reduction(%)    avg.psnr  ovr.psnr   ssim\n   7         -0.235         -0.0042   -0.0087   -0.0016\n   8          0.183         -0.0047   -0.0034   -0.0012\n   9          0.030          0.0004    0.0078    0.0375\n\n In BD-Rate Loss column:\n [+] sign is for BD-Rate drop\n [-] sign is for BD-Rate improvement\n\nPlease review the patch.\nThank you.",
      "revId": "a46bed20f9cf8ec506d7f8bde8ead22d6bd2fd5c",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}