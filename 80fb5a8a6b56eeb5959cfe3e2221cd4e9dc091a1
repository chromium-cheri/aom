{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "acec79ad_f15a073a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 25857
      },
      "writtenOn": "2023-01-04T15:25:05Z",
      "side": 1,
      "message": "Hi Wan-Teh, Frank, \n\nSuperblock size of 128x128 may not be required during allintra encoding since maximum partition size is 32x32 for speed\u003e\u003d6. In this CL, SB size of 64X64 is forced to improve the multi thread performance, by reducing top-right delay and thread sync wastage. \n\nThis setting is enabled only for speed\u003e\u003d9 and resolutions less than 4k due to the below reasons:\n1. For speed\u003c9, cost update happens at a superblock level(INTERNAL_COST_UPD_SB). Hence, reducing the SB size seems to increase the frequency of update and result in an increase in encode time.\n2. For speed\u003d9 and resolutions \u003e\u003d 4k, cost update happens at SB row level(INTERNAL_COST_UPD_SBROW). Though the single-thread encode time impact is negligible in this case, the calls to av1_avg_cdf_symbols() which happens at a superblock level (during MT) increase and therefore results in an overall encode time increase.\n\nHowever, we tried extending the speed features coeff_cost_upd_level and mode_cost_upd_level from speed 9 to speed 6, 7 and 8, and then applied the setting of SB size to 64X64. But results of extending the speed features were not in trade-off. Hence, we enabled this setting only for speed\u003e\u003d9.\n\nFor AVIF image encode with speed\u003d9\n```\n                 HEAP Memory reduction(%)\nResolution   threads\u003d1    threads\u003d4\n768x512         5.100       8.515\n1280x720        2.615       3.130\n```\n\nThis CL doesn’t have any impact for resolutions \u003c\u003d480p, as SB size is already set to 64X64 for these resolutions. The heap memory reduction is mainly due to the buffer size reduction of thread_data-\u003etd-\u003evt64x64, thread_data-\u003etd-\u003eshared_coeff_buf etc.\n\nHEAP memory reduction was measured using the following command:\n$valgrind --tool\u003dmassif ./avifenc ...\n\nFor libaom AV1 video encode, bit-match is verified (w.r.t. parent commit) for \u0027GOOD\u0027 and \u0027RT\u0027 encoding modes for a few contents with different encoding configurations. It is verified that the CL is bit-exact for allintra encode, speed \u003c 9 with no speed impact.\n\nPlease review.\n\nRegards,\nMudassir",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ce7ffda0_b03f292e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-01-04T22:39:50Z",
      "side": 1,
      "message": "Chi Yo: Could you also review this CL? Thanks.",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5318cf1c_2e7dd007",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 25857
      },
      "writtenOn": "2023-01-06T14:51:51Z",
      "side": 1,
      "message": "Hi Wan-Teh,\n\nPlease let us know your opinion on our response.\n\nRegards,\nMudassir",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7887a961_a7c4a45f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-01-09T23:15:29Z",
      "side": 1,
      "message": "LGTM.",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eccd63f9_23df85b2",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 1
      },
      "lineNbr": 834,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-01-04T22:39:50Z",
      "side": 1,
      "message": "If we can pass `sf` to this function, should we change the condition in line 836 to the following then?\n\n```\n    if (oxcf-\u003emode \u003d\u003d ALLINTRA \u0026\u0026\n        sf-\u003epart_sf.default_max_partition_size \u003d\u003d BLOCK_32X32 \u0026\u0026\n        sf-\u003einter_sf.coeff_cost_upd_level \u003d\u003d INTERNAL_COST_UPD_OFF \u0026\u0026\n        sf-\u003einter_sf.mode_cost_upd_level \u003d\u003d INTERNAL_COST_UPD_OFF)\n```\n\nThis will remove the coupling between this conditional expression and the corresponding code in av1/encoder/speed_features.c.",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "54bf1726_e36ea5fe",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 1
      },
      "lineNbr": 834,
      "author": {
        "id": 25857
      },
      "writtenOn": "2023-01-06T14:51:51Z",
      "side": 1,
      "message": "The  buffers like txb_buf, shared_coeff_buf and sms_tree etc are allocated (please see alloc_compressor_data()) based on the superblock size set by av1_select_sb_size() during control calls. As speed features are not correctly set by this time, using speed features may not be a feasible solution.",
      "parentUuid": "eccd63f9_23df85b2",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "35ed41ae_6beae5f3",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 1
      },
      "lineNbr": 834,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-01-09T23:15:29Z",
      "side": 1,
      "message": "Thank you.",
      "parentUuid": "54bf1726_e36ea5fe",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "919c5c98_efca2b9a",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 1
      },
      "lineNbr": 835,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-01-04T22:39:50Z",
      "side": 1,
      "message": "This test assumes `width` is `cm-\u003ewidth` and `height` is `cm-\u003eheight`. This is not always true when this function is called. For example, this function may be called with `width\u003doxcf-\u003efrm_dim_cfg.width` and `height\u003doxcf-\u003efrm_dim_cfg.height`.\n\nIs this a problem?",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ab825c21_79f68064",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 1
      },
      "lineNbr": 835,
      "author": {
        "id": 25857
      },
      "writtenOn": "2023-01-06T14:51:51Z",
      "side": 1,
      "message": "Since this setting is enabled only when superres_mode is AOM_SUPERRES_NONE and resize_mode is RESIZE_NONE (please check line 817), both oxcf-\u003efrm_dim_cfg.width/height and cm-\u003ewidth/height would be the same. Hence this shouldn’t be a problem.",
      "parentUuid": "919c5c98_efca2b9a",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0318b5d6_9670c47c",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 1
      },
      "lineNbr": 835,
      "author": {
        "id": 9545
      },
      "writtenOn": "2023-01-09T23:15:29Z",
      "side": 1,
      "message": "Thank you.",
      "parentUuid": "ab825c21_79f68064",
      "revId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ],
  "submitRequirementResults": [
    {
      "submitRequirement": {
        "name": "Code-Review",
        "description": {
          "value": "At least one maximum vote for label \u0027Code-Review\u0027 is required"
        },
        "applicabilityExpression": {},
        "submittabilityExpression": {
          "expressionString": "label:Code-Review\u003dMAX,user\u003dnon_uploader AND -label:Code-Review\u003dMIN"
        },
        "overrideExpression": {
          "value": {
            "expressionString": "label:Bot-Commit\u003d+1 AND -label:Code-Review\u003dMIN"
          }
        },
        "allowOverrideInChildProjects": true
      },
      "applicabilityExpressionResult": {},
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"label:Code-Review=MAX,user=non_uploader AND -label:Code-Review=MIN"},"status":"PASS","errorMessage":{"value":null},"passingAtoms":["label:Code-Review=MAX,user=non_uploader"],"failingAtoms":["label:Code-Review=MIN"]}
      },
      "overrideExpressionResult": {
        "value": {"expression":{"expressionString":"label:Bot-Commit=+1 AND -label:Code-Review=MIN"},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["label:Bot-Commit=+1","label:Code-Review=MIN"]}
      },
      "patchSetCommitId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {}
    },
    {
      "submitRequirement": {
        "name": "Review-Enforcement",
        "description": {
          "value": "Two Google employees must approve the change. Uploading the change or voting positively on Code-Review count as approval."
        },
        "applicabilityExpression": {
          "value": {
            "expressionString": "is:review-enforced_gerrit"
          }
        },
        "submittabilityExpression": {
          "expressionString": "is:review-enforcement-satisfied_gerrit"
        },
        "overrideExpression": {},
        "allowOverrideInChildProjects": false
      },
      "applicabilityExpressionResult": {
        "value": {"expression":{"expressionString":"is:review-enforced_gerrit"},"status":"PASS","errorMessage":{"value":null},"passingAtoms":["is:review-enforced_gerrit"],"failingAtoms":[]}
      },
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"is:review-enforced_gerrit"},"status":"PASS","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["is:review-enforcement-satisfied_gerrit"]}
      },
      "overrideExpressionResult": {},
      "patchSetCommitId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {
        "value": true
      }
    },
    {
      "submitRequirement": {
        "name": "Verified",
        "description": {
          "value": "CI or human verified the change"
        },
        "applicabilityExpression": {},
        "submittabilityExpression": {
          "expressionString": "label:Verified\u003dMAX AND -label:Verified\u003dMIN"
        },
        "overrideExpression": {
          "value": {
            "expressionString": "label:Bot-Commit\u003d+1"
          }
        },
        "allowOverrideInChildProjects": true
      },
      "applicabilityExpressionResult": {},
      "submittabilityExpressionResult": {
        "value": {"expression":{"expressionString":"label:Verified=MAX AND -label:Verified=MIN"},"status":"PASS","errorMessage":{"value":null},"passingAtoms":["label:Verified=MAX"],"failingAtoms":["label:Verified=MIN"]}
      },
      "overrideExpressionResult": {
        "value": {"expression":{"expressionString":"label:Bot-Commit=+1"},"status":"FAIL","errorMessage":{"value":null},"passingAtoms":[],"failingAtoms":["label:Bot-Commit=+1"]}
      },
      "patchSetCommitId": "80fb5a8a6b56eeb5959cfe3e2221cd4e9dc091a1",
      "legacy": {
        "value": false
      },
      "forced": {},
      "hidden": {}
    }
  ]
}