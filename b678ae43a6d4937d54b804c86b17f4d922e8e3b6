{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "3b0f9a4b_72233f38",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 9616
      },
      "writtenOn": "2021-10-28T09:39:40Z",
      "side": 1,
      "message": "Hi Yunqing,\n\nThis patch enables the use of superblock size 64x64 for resolutions less than or equal to 1080p for speed \u003e\u003d 4 based on oxcf-\u003emax_threads and tile configurations.\n\nPlease find below, the vbr borg results with --threads\u003d16 (Ref: sb_size\u003d128x128, Test: sb_size:64x64):\n\n         |                | Tile config |       BD-Rate Impact(%)     |\ncpu-used |    Resolution  |(rows x cols)| avg.psnr  ovr.psnr   ssim   |\n-------- | ---------------| ------------| --------  --------  --------|\n   4     | hdres2 - 720p  |      1x1    |  0.9943    0.9864   0.5143  |\n   4     | hdres2 - 1080p |      1x1    |  0.8638    0.8395   0.7090  |\n-----------------------------------------------------------------------\n   5     | hdres2 - 720p  |      1x1    |  0.6731    0.6401   0.1349  |\n   5     | hdres2 - 720p  |      2x2    |  0.7435    0.7182   0.1541  |\n   5     | hdres2 - 1080p |      1x1    |  0.4252    0.3657  -0.0506  |\n   5     | hdres2 - 1080p |      2x4    |  0.3630    0.3434  -0.0138  |\n-----------------------------------------------------------------------\n   6     | hdres2 - 720p  |      1x1    |  0.5763    0.5623   0.1397  |\n   6     | hdres2 - 720p  |      2x2    |  0.6730    0.6760   0.3572  |\n   6     | hdres2 - 1080p |      1x1    |  0.4064    0.3485   0.0866  |\n   6     | hdres2 - 1080p |      2x4    |  0.3216    0.2671  -0.0474  |\n   \nIn the BD rate impact column:\n[+] sign is for BD-Rate drop\n[-] sign is for BD-Rate improvement\n\nPlease find the CQP encode time reductions for different thread configurations below (Ref: sb_size\u003d128x128, Test: sb_size:64x64):\n\n         |                | Tile config | Average encode time reduction(%)|\ncpu-used |    Resolution  |(rows x cols)|   th4    th6      th8     th12  |\n-------- | ---------------| ------------|  ---     ---      ---     ---   | \n   4     |       720p     |      1x1    |  18.61   19.51   19.2    19.72  |\n   4     |      1080p     |      1x1    |  12.19   21.52   24.13   22.75  |\n---------------------------------------------------------------------------\n   5     |       720p     |      1x1    |  22.61   23.19   18.42   16.74  |\n   5     |       720p     |      2x2    |   6.00   13.00   18.46   24.76  |\n   5     |      1080p     |      1x1    |  11.3    23.32   25.82   21.75  |\n   5     |      1080p     |      2x4    |   3.13     -      7.26   13.16  |\n---------------------------------------------------------------------------\n   6     |       720p     |      1x1    |  22.57   21.96   14.51   12.74  |\n   6     |       720p     |      2x2    |   3.73    9.95   16.67   24.23  |\n   6     |      1080p     |      1x1    |  10.28   22.06   22.84   16.3   |\n   6     |      1080p     |      2x4    |   1.58     -      4.75   10.51  |\n   \nNote: Profile data was obtained on 6 720p clips and 3 1080p clips for qp points 20 and 55 with --limit\u003d60 and --lag-in-frames\u003d19.\n\nWith this change, a test in \u0027AVxFirstPassEncoderThreadTest\u0027 which compares first pass encoding stats of threads\u003d2 and threads\u003d4 for bitmatch (for 720p, speed 4) becomes invalid and is hence removed (for all test presets).\n\nPlease review this patch.\n\nRegards,\nRemya\n",
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "eaadb24e_c3edef89",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-10-28T16:46:39Z",
      "side": 1,
      "message": "Thanks for the detailed results. It is good to make decisions based on the results. This is fine. Just one concern: if we make the logic too complicated, it might cause difficulties for our future experiments since every case works differently.",
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9c18c779_bf551040",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 9616
      },
      "writtenOn": "2021-10-29T14:18:56Z",
      "side": 1,
      "message": "Hi Yunqing,\n\nThe current logic is relatively simpler for speed \u003e\u003d 5, with the choice of SB size made based on the no. of threads (\u003e\u003d 4) and resolution (\u003c\u003d 1080p). For speed 4, additionally, the threshold on threads changes based on 720p or 1080p, as well as enabling SB 64x64 for only single tile encodes. If necessary, we can change the threshold on no. of threads based on resolution to simplify the logic (at some speed loss for 720p with 4 or 5 threads). Please let us know your opinion.\n\nPlease review.\n\nRegards,\nRemya",
      "parentUuid": "eaadb24e_c3edef89",
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "25817d5d_7b96137f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-10-29T16:36:09Z",
      "side": 1,
      "message": "Can we make this SB size decision only based on resolution and speed? I feel people would turn on tile-mt before FPMT, so multi-tile + fpmt should be the case to focus on. Namely, we should weigh more on performance of multi-tile case. I would suggest we look at the overall performance at multi-tile case to make the decision. If the performance is worse in some situation (i.e. lower # of threads), we probably have to deal with it.\n\nAlso, we can decide when to use fpmt to overcome decision difficulty. E.g. if we see 4 tiles and 4 threads, we can disable fpmt. Would that help?",
      "parentUuid": "9c18c779_bf551040",
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d9c5b0b9_8f30857c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 9616
      },
      "writtenOn": "2021-11-02T14:30:34Z",
      "side": 1,
      "message": "As suggested, we have enabled the use of superblock size 64x64, only based on resolution ( \u003c\u003d 1080p) and speed ( \u003e\u003d 5 ) during multi-thread encode. With this setting, the speed-quality data is within trade-off  for both single-tile and multi-tile encodes. We have also verified that for single-tile encode, the encode time reduction obtained with FPMT and SB 64x64 is similar to that with SB 128x128. \n\nFor multi-tile encode with FPMT and SB 64x64, we shall tune num_fp_contexts computation for obtaining optimal results as you suggested.",
      "parentUuid": "25817d5d_7b96137f",
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ff3eb20d_71894dae",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-11-02T16:12:51Z",
      "side": 1,
      "message": "The change looks good. Thanks for the work!",
      "parentUuid": "d9c5b0b9_8f30857c",
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4272fd59_59051505",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 2
      },
      "lineNbr": 805,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-10-28T16:46:39Z",
      "side": 1,
      "message": "Using multi-tiles is the general practice in HD encoding. From the result table, multi-tile case speedup was quite worse than that of single tile while using SB 64x64.",
      "range": {
        "startLine": 805,
        "startChar": 10,
        "endLine": 805,
        "endChar": 26
      },
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "90fc74b3_a52fe6d0",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 2
      },
      "lineNbr": 805,
      "author": {
        "id": 9616
      },
      "writtenOn": "2021-10-29T14:18:56Z",
      "side": 1,
      "message": "Though the speed-up with multi-tiles is lower than that of single-tile gains, especially  at lower threads, the results are within trade-off for presets 5 and 6. We can also choose to disable SB 64x64 for multi-tile encode altogether (which will simplify the logic). Please let us know your opinion.",
      "parentUuid": "4272fd59_59051505",
      "range": {
        "startLine": 805,
        "startChar": 10,
        "endLine": 805,
        "endChar": 26
      },
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "87cd4a20_f75948b3",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 2
      },
      "lineNbr": 805,
      "author": {
        "id": 5185
      },
      "writtenOn": "2021-10-29T16:36:09Z",
      "side": 1,
      "message": "As mentioned above, for hd+ res, single-tile + fpmt probably isn\u0027t what we want to care about. It is ok to test with it during performance analysis. But I couldn\u0027t think of any real usage of it.",
      "parentUuid": "90fc74b3_a52fe6d0",
      "range": {
        "startLine": 805,
        "startChar": 10,
        "endLine": 805,
        "endChar": 26
      },
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "29a788c6_7366b31c",
        "filename": "av1/encoder/encoder_utils.c",
        "patchSetId": 2
      },
      "lineNbr": 805,
      "author": {
        "id": 9616
      },
      "writtenOn": "2021-11-02T14:30:34Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "87cd4a20_f75948b3",
      "range": {
        "startLine": 805,
        "startChar": 10,
        "endLine": 805,
        "endChar": 26
      },
      "revId": "b678ae43a6d4937d54b804c86b17f4d922e8e3b6",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}