{
  "comments": [
    {
      "key": {
        "uuid": "edcdbadb_54432176",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 15298
      },
      "writtenOn": "2020-09-26T10:34:27Z",
      "side": 1,
      "message": "Hi Yunqing,\n\nWhile analysing the statistics differences between 8-bit and 10-bit encodes for prune_palette_search_level speed feature, we observed that the number of times the speed feature is invoked is different in lbd and hbd encoding.\nThis is because the total number of distinct pixel values in a block was compared against same thresholds in both lbd and hbd encoding to gate the evaluation of palette mode search.\nIn high bit-depth encoding, the number of distinct pixel values is usually much higher than that in low bit-depth encoding, resulting in more pruning of palette mode in high bit-depth path.\n\nThis patch removes the inconsistency across the evaluations of lbd and hbd encoding by down-converting the pixels to 8-bit domain before obtaining the total count in av1_count_colors_highbd(). Detailed borg results for 10-bit encode are as follows,\n\n cpu-used Resolution  Instruction count           BD-Rate Impact(%) \n                        Reduction(%)     avg.psnr ovr.psnr  ssim      avg.psnr  \n                                          8-bit    8-bit    8-bit      10-bit                                                   \n    0      Lowres       -0.004            0        -0.001  -0.002     -0.001\n    0      Midres       -0.023            0.029     0.038   0.049      0.029\n    0      Hdres        -0.011            0         0       0          0\n    0      Overall      -0.01             0.008     0.010   0.014      0.008\n\n    1      Lowres        0.008           -0.001    -0.001  -0.012     -0.001\n    1      Midres       -0.016           -0.014    -0.015  -0.020     -0.015\n    1      Hdres        -0.016            0         0       0          0    \n    1      Overall      -0.003           -0.004    -0.005  -0.011     -0.005\n\n    2      Lowres       -0.014            0.001     0.002   0.008      0.001\n    2      Midres       -0.073            0.054     0.061   0.091      0.052\n    2      Hdres        -0.038           -0.003    -0.003  -0.001     -0.003\n    2      Overall      -0.034            0.015     0.017   0.029      0.015\n\n    3      Lowres       -0.029            0         0      -0.004      0.001\n    3      Midres        0.015           -0.022    -0.029  -0.04      -0.022\n    3      Hdres        -0.026           -0.001    -0.001  -0.001     -0.001\n    3      Overall      -0.017           -0.007    -0.009  -0.014     -0.007\n\n    4      Lowres       -0.036            0         0.001   0.005      0\n    4      Midres       -0.017           -0.063    -0.067  -0.107     -0.062\n    4      Hdres        -3.401           -0.494    -0.487  -0.435     -0.495\n    4      Overall      -0.886           -0.1693   -0.168  -0.162     -0.169\n\n    5      Lowres       -0.077            0.001     0.001  -0.007      0.001\n    5      Midres       -0.153            0.001     0       0.002      0.001\n    5      Hdres        -6.568           -1.093    -1.079  -0.965     -1.095\n    5      Overall      -1.745           -0.333    -0.329  -0.297     -0.333\n\n    6      Lowres       -0.085            0         0       0.003      0\n    6      Midres       -0.223           -0.020    -0.021  -0.006     -0.02\n    6      Hdres        -0.12            -0.040    -0.038  -0.055     -0.039\n    6      Overall      -0.127           -0.018    -0.018  -0.018     -0.018\n\nWe tested on few screen contents like Dota2_360p, Minecraft, screendata, Wikipedia, chinaspeed_xga etc. In 12bit encode we are seeing overall quality gain of around 5.5% for preset 5 and 6 for above clips.\n\nPlease review the patch.\n\nThanks\n",
      "revId": "c6afea485022fb6b6c531f52f82501ae35774ead",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "4f134355_7b955f56",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 5185
      },
      "writtenOn": "2020-09-28T17:54:16Z",
      "side": 1,
      "message": "Hi Cheng, could you review this CL?",
      "revId": "c6afea485022fb6b6c531f52f82501ae35774ead",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b424064e_6adf17ef",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 6585
      },
      "writtenOn": "2020-09-28T18:03:59Z",
      "side": 1,
      "message": "Sure.",
      "parentUuid": "4f134355_7b955f56",
      "revId": "c6afea485022fb6b6c531f52f82501ae35774ead",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "d85b46c2_0c3c0695",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 6585
      },
      "writtenOn": "2020-09-28T18:23:51Z",
      "side": 1,
      "message": "Thanks for the detailed testing.\n\nAre these metrics the performance comparisons between 10-bit encoding and 8-bit encoding? (They are under columns 8-bit)?\n\nThis change should reduce the pruning of palette mode. Why do we see less instruction count?",
      "parentUuid": "edcdbadb_54432176",
      "revId": "c6afea485022fb6b6c531f52f82501ae35774ead",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ad553804_5cc090e9",
        "filename": "av1/encoder/intra_mode_search.c",
        "patchSetId": 4
      },
      "lineNbr": 179,
      "author": {
        "id": 5185
      },
      "writtenOn": "2020-09-28T17:54:16Z",
      "side": 1,
      "message": "Possible to combine this with av1_count_colors()?",
      "range": {
        "startLine": 179,
        "startChar": 4,
        "endLine": 179,
        "endChar": 27
      },
      "revId": "c6afea485022fb6b6c531f52f82501ae35774ead",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "aca77d59_5a2ceb53",
        "filename": "av1/encoder/intra_mode_search.c",
        "patchSetId": 4
      },
      "lineNbr": 182,
      "author": {
        "id": 5185
      },
      "writtenOn": "2020-09-28T17:54:16Z",
      "side": 1,
      "message": "Sounds right. We also need to modify av1_set_screen_content_options accordingly. For example, int count_buf[1 \u003c\u003c 12].",
      "range": {
        "startLine": 182,
        "startChar": 12,
        "endLine": 182,
        "endChar": 32
      },
      "revId": "c6afea485022fb6b6c531f52f82501ae35774ead",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": true
    }
  ]
}