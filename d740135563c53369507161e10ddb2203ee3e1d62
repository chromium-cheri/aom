{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "70a5834e_1f2944f5",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 22433
      },
      "writtenOn": "2021-12-27T07:14:27Z",
      "side": 1,
      "message": "Hi Wan-Teh, Yunqing,\n\nAs per our study, the screen content coding tools (i.e. palette and intraBC) are not evaluated in case of non-RD encoding mode, i.e., when use_nonrd_pick_mode\u003d1 with hybrid_intra_pickmode\u003d0. Currently in non-RD encoding mode, the decision to choose between non-RD/RD intra mode search is taken in hybrid_intra_mode_search() based on sf “hybrid_intra_pickmode” and block size as shown below.\n\n Static void hybrid_intra_mode_search() {\n if (cpi-\u003esf.rt_sf.hybrid_intra_pickmode \u0026\u0026 bsize \u003c BLOCK_16X16)\n     av1_rd_pick_intra_mode_sb();\n   else\n     av1_nonrd_pick_intra_mode();\n }\n\nThe function av1_nonrd_pick_intra_mode() is invoked always for the above mentioned case (i.e.  when use_nonrd_pick_mode\u003d1 and hybrid_intra_pickmode\u003d0) and screen content coding tools are not evaluated in this path. Hence, we have introduced an early exit in the av1_set_screen_content_options() function as the decisions made here are not affecting screen content tools evaluation. Currently, this change is applicable for allintra encode speed \u003e\u003d 9.\n\nWe validated the current patch for ‘ALLINTRA’ video encode and still-image encode. Following are encode time reduction results when AVIF encode was tested for a typical image dataset. Bit match is verified for presets 0 to 8.\n\nFor AVIF still image encode with tune\u003dpsnr,\n                  Encode Time      BD-Rate Loss(%)      \n      cpu-used    Reduction(%)     psnr     ssim\n         9          2.630         -0.0006  -0.0006\n\t\t \nFor AVIF still image encode with tune\u003dssim,\n                  Encode Time      BD-Rate Loss(%)      \n      cpu-used    Reduction(%)     psnr     ssim\n         9          2.890         -0.0006  -0.0006\n\t\t \nFollowing are Instruction Count reduction results when tested libaom with all intra frame encoding for a borg setup. Bit match is verified for preset 0 to 8.\n               Instruction Count       BD-Rate Loss(%)      \n     cpu-used    Reduction(%)     avg.psnr  ovr.psnr   ssim\n         9         1.010         -0.0028   -0.0028    -0.0028\n\nFor speed 9, this change is bit-exact for non-screen contents whereas for screen-contents (detected in the parent version) the bit-mismatch is seen as some of the flags are dependent on allow_screen_content_tools (Eg : allow_intrabc) and allow_screen_content_tools\u003d0 after this CL.\n\nFor libaom AV1 video encode, bit match is verified (w.r.t parent commit) for encoding modes \u0027GOOD\u0027 and \u0027RT\u0027 for few videos with different video encoding configurations.\n\nIn the commit message, BD rate impact column:\n[+] sign is for BD-Rate drop\n[-] sign is for BD-Rate improvement\nThe instruction count reduction specified has been measured using the command:\n$ perf stat -e instructions:u ./avifenc …\n\nPlease review.\n\nRegards,\nAniket.\n",
      "revId": "d740135563c53369507161e10ddb2203ee3e1d62",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "01f44901_85054a84",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 29312
      },
      "writtenOn": "2021-12-29T01:49:25Z",
      "side": 1,
      "message": "sorry your not the owners your information rapist",
      "revId": "d740135563c53369507161e10ddb2203ee3e1d62",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c82aafcb_47cba34d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-12-29T19:18:46Z",
      "side": 1,
      "message": "Fyodor: PTAL. Thanks!\n\nAniket: I have a question below.",
      "revId": "d740135563c53369507161e10ddb2203ee3e1d62",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "559496a8_19b4f183",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-12-29T19:18:46Z",
      "side": 1,
      "message": "Hi Aniket,\n\nWhen I read the following sentence in the commit message:\n\u003e The screen content coding tools (i.e. palette and intraBC) are not\n\u003e evaluated in non-RD encoding mode, i.e., when use_nonrd_pick_mode \u003d 1\n\u003e and hybrid_intra_pickmode \u003d 0.\n\nI expected this CL to be bit-exact.\n\nBut you wrote:\n\u003e For [allintra encode] speed 9, this change is bit-exact for non-screen contents\n\u003e whereas for screen-contents (detected in the parent version) the bit-mismatch\n\u003e is seen as some of the flags are dependent on allow_screen_content_tools\n\u003e (Eg : allow_intrabc) and allow_screen_content_tools\u003d0 after this CL.\n\nAre you saying that the values of allow_screen_content_tools and allow_intrabc still affect the encoded output even when the screen content coding tools (i.e. palette and intraBC) are not evaluated?",
      "parentUuid": "70a5834e_1f2944f5",
      "revId": "d740135563c53369507161e10ddb2203ee3e1d62",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a975b63e_4d416933",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 22433
      },
      "writtenOn": "2021-12-30T11:11:09Z",
      "side": 1,
      "message": "Yes, though the screen content coding tools (i.e. palette and intraBC) are not evaluated, the flags ‘allow_screen_content_tools’ and ‘allow_intrabc’ affect the encoded output in terms of reduction in bits w.r.t. parent version.\nIn the parent version, when the ‘allow_screen_content_tools’ is set to 1, the flags ‘allow_intrabc’ and ‘cur_frame_force_integer_mv’ had to be explicitly written to the bitstream. In the current CL, as the flag ‘allow_screen_content_tools’ is set as default (i.e. to 0), the other flags ‘allow_intrabc’ and ‘cur_frame_force_integer_mv’ are not written to the bitstream and are assumed implicitly as 0.\n\nAnd also in the parent version, the function ‘write_palette_mode_info()’ is getting called to signal the usage of palette mode (even though palette tool is not evaluated) based on the ‘allow_screen_content_tools’ flag. This in turn causes a bit-mismatch w.r.t parent version as the ‘allow_screen_content_tools’ flag is not set in current CL.",
      "parentUuid": "559496a8_19b4f183",
      "revId": "d740135563c53369507161e10ddb2203ee3e1d62",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "64a67ea2_07cef759",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2022-01-04T22:42:24Z",
      "side": 1,
      "message": "Thank you for the reply. I found the corresponding places in the bitstream in the AV1 specification and verified that they depend on the allow_screen_content_tools flag. Thank you for the explanation.",
      "parentUuid": "a975b63e_4d416933",
      "revId": "d740135563c53369507161e10ddb2203ee3e1d62",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "dcdf09a8_7c288658",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2022-01-04T23:17:25Z",
      "side": 1,
      "message": "Hi Aniket,\n\nI have a follow-up question. I understand this CL changes the encoded output when the parent version would set the ‘allow_screen_content_tools’ flag to 1. But the decoded output should remain the same, right?\n\nIf so, does this mean STATS_CHANGED must be set even though the decoded output remains the same?",
      "parentUuid": "64a67ea2_07cef759",
      "revId": "d740135563c53369507161e10ddb2203ee3e1d62",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}