{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "2fa7e1a5_32ef8873",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 14993
      },
      "writtenOn": "2021-02-19T16:23:40Z",
      "side": 1,
      "message": "Hi Wan-Teh, Jingning,\n\nAs per our understanding, the last source frame buffer present in the queue of cpi-\u003elookahead and cpi-\u003escaled_last_source are not required for all-intra frame encoding (kf-max-dist\u003d0). Hence, we introduced a conditional allocation for these buffers based on key-freq-max\u003d0.\n \nIt was observed that for single-pass encoding mode with LAP enabled (\u0027good\u0027 preset), firstpass_inter_prediction() was being called in LAP stage, even though kf-max-dist was set to 0. This is not expected as per our understanding.\n\nThis issue could be solved by either of following approaches:\n1) By using fixed_kf_cntr logic to populate frame_flags\n2) Populating kf_requested flag based on kf-max-dist\u003d0\n\nWe did not pursue approach (1) as that piece of code is under the check \"kf_mode \u003d\u003d AOM_KF_AUTO\". The value of kf_mode is set to AOM_KF_DISABLED for the newly added --allintra mode. Hence, we thought that approach (2) would be better as it would handle kf-max-dist\u003d0 for all kf_mode values (AOM_KF_DISABLED/AOM_KF_AUTO). \n\nWith the current patch in all-intra frame encoding, we observed better bit-rate adherence as active_worst_quality is populated appropriately after the modification (coded_error -\u003e section_error -\u003e active_worst_quality). As a specific example, for \"rush_hour_1080p25\" content with target-bitrate\u003d5700kbps, the achieved bit-rate reduced from 29.2Mbps (parent version) to 8.55Mbps (with the current patch).\n\nWe validated the current patch for video and still-image encode. Specifically, we configured libaom in ALLINTRA mode (in libavif) for AVIF encode.\n \nIt was verified that output of AVIF encode is bit-exact with parent version for a typical image dataset.  \n\nFollowing are memory reduction results when AVIF encode was tested for ‘building.jpg’ (4032x3024) image at cq_level\u003d18.\n   Speed                 HEAP Memory\n   preset                Reduction(%)\n     6          ~8.04 (from 518.3 MB to 476.6 MB)\n     \nHEAP memory reduction was measured using the command below.\n$valgrind --tool\u003dmassif ./avifenc ...\n\nRegards,\nJayasanker.",
      "revId": "8626a76372cd5b8d6022c99be229b3d0baac2041",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "265bc865_aa134530",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 14993
      },
      "writtenOn": "2021-02-22T07:56:49Z",
      "side": 1,
      "message": "Hi Wan-Teh, Jingning,\n\nThe approach implemented in the current patch (using kf-max-dist) is based on the nature of the algorithms implemented in the encoder at present,  as summarized in the following issue:\n\nhttps://bugs.chromium.org/p/aomedia/issues/detail?id\u003d2967\n\nAs an alternate approach, we can implement this memory optimization by making use of \u0027g_limit\u003d\u003d1\u0027. But, this implementation will limit the scope of this memory optimization to still image encoding only.  Hence we pursued the optimization as present in the current patch. We are also not entirely sure if the \u0027g_limit\u0027 based approach is recommended. \n\nPlease let us know your thoughts on our approach/understanding.\n\nRegards,\nJayasanker.",
      "parentUuid": "2fa7e1a5_32ef8873",
      "revId": "8626a76372cd5b8d6022c99be229b3d0baac2041",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f7f93bb1_c3e8b681",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-02-23T04:31:41Z",
      "side": 1,
      "message": "Hi Jayasanker, thanks a lot for the CL. I have some questions.",
      "revId": "8626a76372cd5b8d6022c99be229b3d0baac2041",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "efb5c89e_7d9f6b90",
        "filename": "av1/encoder/encode_strategy.c",
        "patchSetId": 2
      },
      "lineNbr": 1270,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-02-23T04:31:41Z",
      "side": 1,
      "message": "Just curious: Does any of the other changes in this CL depend on this change? This change seems independent of the other changes.",
      "revId": "8626a76372cd5b8d6022c99be229b3d0baac2041",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "63fd9757_7b611054",
        "filename": "av1/encoder/encoder_alloc.h",
        "patchSetId": 2
      },
      "lineNbr": 403,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-02-23T04:31:41Z",
      "side": 1,
      "message": "Could you explain how you concluded cpi-\u003escaled_last_source is not used for all-intra frame encoding?\n\nMy code analysis shows this eventually becomes cpi-\u003elast_source. cpi-\u003elast_source is used in two funcitons.\n\n1. av1_source_content_sb(): This function is not called for key frames.\n\n2. av1_update_noise_estimate(): It seems that this function may be called for key frames.",
      "range": {
        "startLine": 402,
        "startChar": 31,
        "endLine": 403,
        "endChar": 59
      },
      "revId": "8626a76372cd5b8d6022c99be229b3d0baac2041",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0cb51f05_0e43edcd",
        "filename": "av1/encoder/lookahead.c",
        "patchSetId": 2
      },
      "lineNbr": 57,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-02-23T04:31:41Z",
      "side": 1,
      "message": "This needs to be done after the null check for \u0027ctx\u0027, which is currently at line 66 below.\n\nA good solution is to add, after line 54, the following:\n\n  if (!ctx) return ctx;\n\nand delete line 66 and line 86.\n\nAlternatively, you can declare a local variable named max_pre_frames here, and use it until you have allocated \u0027ctx\u0027 and set ctx-\u003emax_pre_frames to this local variable:\n\n  // For all-intra frame encode, previous source frames are not used. Hence\n  // max_pre_frames is set to 0 in this case. \n  uint8_t max_pre_frames \u003d is_all_intra ? 0 : MAX_PRE_FRAMES;\n\n  // Add the lags to depth and clamp\n  depth +\u003d num_lap_buffers;\n  depth \u003d clamp(depth, 1, MAX_TOTAL_BUFFERS);\n\n  // Allocate memory to keep previous source frames available.\n  depth +\u003d max_pre_frames;\n\n  // Allocate the lookahead structures\n  ctx \u003d calloc(1, sizeof(*ctx));\n  if (ctx) {\n    unsigned int i;\n    ctx-\u003emax_sz \u003d depth;\n    ctx-\u003epush_frame_count \u003d 0;\n    ctx-\u003emax_pre_frames \u003d max_pre_frames;\n    ...",
      "revId": "8626a76372cd5b8d6022c99be229b3d0baac2041",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b3e09be7_5947d98d",
        "filename": "av1/encoder/lookahead.h",
        "patchSetId": 2
      },
      "lineNbr": 71,
      "author": {
        "id": 9545
      },
      "writtenOn": "2021-02-23T04:31:41Z",
      "side": 1,
      "message": "I suggest we include \u003cstdbool.h\u003e and declare this parameter as the \u0027bool\u0027 type.\n\nIt is fine to use the C99 \u0027bool\u0027 type internally in libaom.",
      "revId": "8626a76372cd5b8d6022c99be229b3d0baac2041",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}