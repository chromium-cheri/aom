{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "9c63a33d_fcd0f543",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 9611
      },
      "writtenOn": "2022-09-12T17:51:20Z",
      "side": 1,
      "message": "Hi Yunqing and Marco,\n\nThis CL introduces an early exit for intra-mode evaluation in inter frames based on rdcost calculated using known rate (i.e., rate used here to calculate actual rdcost for comparison with best_rd). Currently, early exit is introduced before luma plane evaluation. The same can be introduced after evaluation of each plane with updated rate. However, we did not pursue the same as it introduces code duplication and the scope seems to be very less.\n\nThis change is a bit-exact and following are the Borg test results.\n```\n                    Instruction Count\n    cpu  Resolution    Reduction(%)\n     7    rtc_derf       0.142\n     8    rtc_derf       0.137\n     9   rtc_screen      0.491\n    10   rtc_screen      0.478\n```\nThe gains seen for other cases are negligible. Please review the patch.\n\nThanks \u0026 Regards,\nVenkata\n",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fc7140d3_d6f7f6b9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 5185
      },
      "writtenOn": "2022-09-13T15:52:04Z",
      "side": 1,
      "message": "Good optimization.",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "27e90969_ded8015b",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2284,
      "author": {
        "id": 5185
      },
      "writtenOn": "2022-09-13T15:52:04Z",
      "side": 1,
      "message": "Question: how would this make it bias to intra modes in screen content case? Final RD calculation is different from the one here?",
      "range": {
        "startLine": 2284,
        "startChar": 26,
        "endLine": 2284,
        "endChar": 54
      },
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bd8cc8c8_84a91a30",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2284,
      "author": {
        "id": 9611
      },
      "writtenOn": "2022-09-13T17:21:45Z",
      "side": 1,
      "message": "Yes Yunqing, for screen content encoding in order to favor intra modes the final RDcost calculated below is reduced (please see line no: 2384) before comparing with best RDcost. The same factor is considered here for early exit in screen contents. \n\nNote that the conditions which decide bias towards/against intra modes can be derived here and use appropriate thresholds/factors for early exit. However, we did not pursue the same as the scope is negligible.\n\nThanks \u0026 Regards,\nVenkata.",
      "parentUuid": "27e90969_ded8015b",
      "range": {
        "startLine": 2284,
        "startChar": 26,
        "endLine": 2284,
        "endChar": 54
      },
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "73cf5d69_8768ffac",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2284,
      "author": {
        "id": 5185
      },
      "writtenOn": "2022-09-13T17:34:10Z",
      "side": 1,
      "message": "Thanks for the explanation. Possible refactoring here: maybe somehow define the reduction (i.e. (7 * inter_mode_thresh) \u003e\u003e 3) as a constant, so if people change it later, it will automatically change both places?",
      "parentUuid": "bd8cc8c8_84a91a30",
      "range": {
        "startLine": 2284,
        "startChar": 26,
        "endLine": 2284,
        "endChar": 54
      },
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2e1d3e5f_83bcf9d7",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2284,
      "author": {
        "id": 9611
      },
      "writtenOn": "2022-09-14T16:22:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "73cf5d69_8768ffac",
      "range": {
        "startLine": 2284,
        "startChar": 26,
        "endLine": 2284,
        "endChar": 54
      },
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7ede584c_db13315f",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2285,
      "author": {
        "id": 5190
      },
      "writtenOn": "2022-09-13T18:34:24Z",
      "side": 1,
      "message": "add force_intra_check to the logic:\n\nif (known_rd \u003e best_rdc-\u003erdcost \u0026\u0026 !force_intra_check)\n\nforce_intra_check was used here to force intra testing to reduce color artifacts we observed in screen testing.",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f8d0dc46_0419b0c1",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2285,
      "author": {
        "id": 5190
      },
      "writtenOn": "2022-09-14T02:17:51Z",
      "side": 1,
      "message": "And this condition (line 2285) is similar/same to the condition already at line 2275, except for the 7/8 factor?",
      "parentUuid": "7ede584c_db13315f",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "19030f2c_8f6d9cc7",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2285,
      "author": {
        "id": 9611
      },
      "writtenOn": "2022-09-14T16:22:35Z",
      "side": 1,
      "message": "Hi Marco,\n\nThis early exit is based on the partial rdcost calculated using known rate and it does not affect the mode decision. i.e., if this condition (line no: 2285) is true, intra mode can not be the winner (for any value of force_intra_check).\n\nThe early exit present at line no:2275 might not happen even when  inter_mode_thresh \u003e best_rdcost, as it is combined with few other conditions. Hence, it is different from the newly added condition (which is line no:2285). Also, the condition at line 2275 is became redundant now due to newly added early exit. Hence, we have removed the same from line 2275.\n\nThanks \u0026 Regards,\nVenkata.",
      "parentUuid": "f8d0dc46_0419b0c1",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "16269655_8c8f9be0",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2285,
      "author": {
        "id": 5190
      },
      "writtenOn": "2022-09-14T19:09:23Z",
      "side": 1,
      "message": "OK with removing the redundant line 2275, given line 2285.\n\nRegarding the force_intra_check: if the intra_cost_penalty() term is changed, increased by some amount, does that still guarantee \"if this condition (line no: 2285) is true, intra mode can not be the winner (for any value of force_intra_check\".",
      "parentUuid": "19030f2c_8f6d9cc7",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4dc18889_ea102023",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2285,
      "author": {
        "id": 9611
      },
      "writtenOn": "2022-09-15T11:02:18Z",
      "side": 1,
      "message": "Yes. As the cost calculated here is partial_rdcost (i.e., known_rd), it is assured that final_rdcost will always be \u003e\u003d partial_rdcost. Please find the details below.\n\nComputation of partial_rdcost(i.e., known_rd):\nRDCOST(x-\u003erdmult, intra_cost_penalty + ref_cost_intra as rate, 0);\nComputation of final_rdcost:\nRDCOST(x-\u003erdmult, actual_rate + intra_cost_penalty + ref_cost_intra, actual_distortion);\n\nBased on the above we feel that it is safe to keep this early exit here as the rate components used will remain same between these 2 computations.\n\nThanks \u0026 Regards,\nVenkata",
      "parentUuid": "16269655_8c8f9be0",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "806d7373_08d7ae3d",
        "filename": "av1/encoder/nonrd_pickmode.c",
        "patchSetId": 3
      },
      "lineNbr": 2285,
      "author": {
        "id": 5190
      },
      "writtenOn": "2022-09-15T18:39:27Z",
      "side": 1,
      "message": "Thanks, i see, missed the line 2375 below. Seems safe then.",
      "parentUuid": "4dc18889_ea102023",
      "revId": "4692119a7304f2359cd8be933eb7b94dcc68c110",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}