{
  "comments": [
    {
      "key": {
        "uuid": "7331a996_d90f7c91",
        "filename": "av1/decoder/decodeframe.c",
        "patchSetId": 4
      },
      "lineNbr": 4407,
      "author": {
        "id": 9545
      },
      "writtenOn": "2018-08-31T17:56:28Z",
      "side": 1,
      "message": "It would be good to add a comment to explain why we cannot release the reference held in cm-\u003enew_fb_idx. (I assume that\u0027s why we reset ref_count to 1 if i is cm-\u003enew_fb_idx.\n\nAlso, we should check if ref_count \u003e\u003d 1 in that case. (If ref_count \u003c 1, remember to call unlock_buffer_pool before calling aom_internal_error.)",
      "range": {
        "startLine": 4407,
        "startChar": 30,
        "endLine": 4407,
        "endChar": 49
      },
      "revId": "92fb42fb90de86889816a4d5c9013e2c5ae78040",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e73cb9e3_ef2f3644",
        "filename": "av1/decoder/decodeframe.c",
        "patchSetId": 4
      },
      "lineNbr": 4407,
      "author": {
        "id": 9545
      },
      "writtenOn": "2018-08-31T17:56:28Z",
      "side": 1,
      "message": "IMPORTANT: I\u0027m sorry I did not think of this issue earlier. The decoder usually calls the decrease_ref_count() function to release a reference to a frame buffer. The decrease_ref_count() function may release the raw_frame_buffer when the reference count is decremented to 0:\n\nstatic INLINE void decrease_ref_count(int idx, RefCntBuffer *const frame_bufs,\n                                      BufferPool *const pool) {\n  if (idx \u003e\u003d 0) {\n    --frame_bufs[idx].ref_count;\n    // A worker may only get a free framebuffer index when calling get_free_fb.\n    // But the private buffer is not set up until finish decoding header.\n    // So any error happens during decoding header, the frame_bufs will not\n    // have valid priv buffer.\n    if (frame_bufs[idx].ref_count \u003d\u003d 0 \u0026\u0026\n        frame_bufs[idx].raw_frame_buffer.priv) {\n      pool-\u003erelease_fb_cb(pool-\u003ecb_priv, \u0026frame_bufs[idx].raw_frame_buffer);\n    }\n  }\n}\n\nShould we call pool-\u003erelease_fb_cb() here? The code would look something like this:\n\n    frame_bufs[i].ref_count \u003d i \u003d\u003d cm-\u003enew_fb_idx ? 1 : 0;\n    if (frame_bufs[i].ref_count \u003d\u003d 0 \u0026\u0026\n        frame_bufs[i].raw_frame_buffer.priv) {\n      cm-\u003ebuffer_pool-\u003erelease_fb_cb(cm-\u003ebuffer_pool-\u003ecb_priv, \u0026frame_bufs[i].raw_frame_buffer);\n    }\n\nNote: Rather than resetting ref_count directly, perhaps this function should call decrease_ref_count() to release references. Unfortunately it is not clear how we can do this.",
      "range": {
        "startLine": 4407,
        "startChar": 4,
        "endLine": 4407,
        "endChar": 58
      },
      "revId": "92fb42fb90de86889816a4d5c9013e2c5ae78040",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0",
      "unresolved": true
    }
  ]
}