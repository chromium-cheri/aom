{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "6cd33156_334a8cba",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 14993
      },
      "writtenOn": "2022-06-26T17:51:12Z",
      "side": 1,
      "message": "Hi Wan-Teh, James, Yunqing,\n\nThis patch introduces an extra top-right delay when the intraBC tool is enabled so as to ensure that a sufficient number of superblocks have finished encoding in the previous rows before starting to encode the current superblock. This ensures that row-multithreaded encoding respects the hardware constraints on\nparallel processing with the intraBC tool and thus prevents any invalid access while building the predictor. \n\nAlso, the unit test ScreenContentToolsMultiThreadTestLarge.ScreenContentToolsTest is reintroduced with thread sanitizer as the data race issue is resolved with this change.\n\nThis change is supposed to  cause an increase in multi-threaded encode-time for video frames where the intraBC tool gets evaluated as the threads need to wait for more superblocks to finish processing in the previous rows. Also, this change could create a potential change in the bitstream for screen contents when encoded with row-multithreading as the invalid access is fixed while building the predictor with intraBC. For non-screen content inputs, this patch has no impact on the coding performance as the encoder behaviour is retained.\n\nWhile working on this issue, we came across a couple of alternate approaches as mentioned below:\n1. Modify “sync_range” by accounting for the intraBC delay: This approach was not taken as the variable “sync_range” also denotes the superblock interval at which the conditional variable should be signalled to resolve dependencies across threads. Changing this variable would introduce additional delay in signalling, which is not desirable.\n2. Decouple “sync_range” and top-right delay by introducing a separate variable for top-right delay: The variable “sync_range” currently implies the top-right delay along with the signalling interval. However, this approach was not taken up as decoupling these functionalities would change the encoder behaviour in default case as the minimum top-right delay expected from “sync_range” will no longer be respected with this approach.\n\nHence, we went ahead with the current approach of maintaining the additional intraBC top-right delay in a separate variable. Please let us know your opinions on our understanding as well as the approach taken.\n\nFor libaom AV1 video encode, bit-match is verified (w.r.t. parent commit) for \u0027GOOD\u0027, \u0027RT\u0027 and \u0027ALLINTRA\u0027 encoding modes for a few non-screen contents with row multi-threading enabled.\n\nPlease review.\n\nRegards,\nJayasanker.",
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "49a49c32_fe050fc6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 5020
      },
      "writtenOn": "2022-06-27T20:18:32Z",
      "side": 1,
      "message": "I\u0027ll leave this open for others to comment",
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "999154b1_eea9594b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 5185
      },
      "writtenOn": "2022-06-28T20:43:45Z",
      "side": 1,
      "message": "Thanks for fixing this!",
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "00fbbcd2_97692811",
        "filename": "av1/encoder/encoder.h",
        "patchSetId": 3
      },
      "lineNbr": 1383,
      "author": {
        "id": 5185
      },
      "writtenOn": "2022-06-28T20:43:45Z",
      "side": 1,
      "message": "Maybe consider this together with sync_range to avoid unnecessary delay? As long as sync_range + intrabc_extra_top_right_sb_delay \u003e\u003d 3 or 5, this should be ok, right? sync_range is at least 1, but can be larger based on resolutions.",
      "range": {
        "startLine": 1383,
        "startChar": 6,
        "endLine": 1383,
        "endChar": 38
      },
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b6d6b3a4_5974fbc7",
        "filename": "av1/encoder/encoder.h",
        "patchSetId": 3
      },
      "lineNbr": 1383,
      "author": {
        "id": 14993
      },
      "writtenOn": "2022-06-29T13:28:37Z",
      "side": 1,
      "message": "With the current implementation, the extra top-right delay is only accounted for during the top-right dependency check in av1_row_mt_sync_read(). As per our understanding, accounting the additional top-right delay with sync_range will introduce additional delay while signalling the conditional variable in av1_row_mt_sync_write() by making the thread wait until it finishes encoding of (sync_range + intrabc_extra_top_right_sb_delay) number of superblocks to signal the progress. Hence we preferred the current approach.\n\nPlease let us know your opinion on our understanding.",
      "parentUuid": "00fbbcd2_97692811",
      "range": {
        "startLine": 1383,
        "startChar": 6,
        "endLine": 1383,
        "endChar": 38
      },
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fddcaf9f_fb80559a",
        "filename": "av1/encoder/encoder.h",
        "patchSetId": 3
      },
      "lineNbr": 1383,
      "author": {
        "id": 5185
      },
      "writtenOn": "2022-06-30T05:10:01Z",
      "side": 1,
      "message": "My question is if this extra_top_right_sb_delay causes MT speed drop? If yes and sync_range \u003e 1, we can lower sync_range to get back the speed loss.",
      "parentUuid": "b6d6b3a4_5974fbc7",
      "range": {
        "startLine": 1383,
        "startChar": 6,
        "endLine": 1383,
        "endChar": 38
      },
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c490b424_b0f34ed4",
        "filename": "av1/encoder/encoder.h",
        "patchSetId": 3
      },
      "lineNbr": 1383,
      "author": {
        "id": 14993
      },
      "writtenOn": "2022-06-30T11:24:24Z",
      "side": 1,
      "message": "\u003e My question is if this extra_top_right_sb_delay causes MT speed drop?\nYes, this extra top-right delay causes MT speed drop for contents where the intraBC tool is evaluated.\n\n\u003e If yes and sync_range \u003e 1, we can lower sync_range to get back the speed loss.\nYes, it is possible to reduce the speed loss by lowering the sync_range as it would reduce the top right delay during sync_read() operation. As per our understanding, a higher sync_range is used to minimize the overheads arising out of sync_write() operations. Hence, both these approaches should be analyzed further to understand which one is better in cases where sync_range \u003e 1. With the current encoder supporting only sync_range of 1, the above scenario is not applicable.\n\nPlease let us know your opinion on our understanding.",
      "parentUuid": "fddcaf9f_fb80559a",
      "range": {
        "startLine": 1383,
        "startChar": 6,
        "endLine": 1383,
        "endChar": 38
      },
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "41195891_8305f9ad",
        "filename": "av1/encoder/ethread.c",
        "patchSetId": 3
      },
      "lineNbr": 1515,
      "author": {
        "id": 5185
      },
      "writtenOn": "2022-06-28T20:43:45Z",
      "side": 1,
      "message": "Good to add this to avoid penalty for other testing.",
      "range": {
        "startLine": 1515,
        "startChar": 2,
        "endLine": 1515,
        "endChar": 39
      },
      "revId": "d01ca1a827d020d65c4e3f518553573f65248ad2",
      "serverId": "e5514cf8-2d6e-3e29-adb4-24cd6dde4bf0"
    }
  ]
}